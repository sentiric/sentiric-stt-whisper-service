# docker-compose.yml

networks:
  sentiric-net:
    name: "${NETWORK_NAME:-sentiric.cloud}"
    driver: bridge
    ipam:
      config:
        - subnet: ${NETWORK_SUBNET:-10.88.0.0/16}
          gateway: ${NETWORK_GATEWAY:-10.88.0.1}


volumes:
  # =============================================================
  # KATMAN 4: YAPAY ZEKA UZMAN MOTORLARI (AI EXPERT ENGINES)
  # Gerçek AI işini yapan, potansiyel olarak yavaş başlayan servisler.
  # =============================================================

  # [capability-stt]: Konuşma Tanıma Yetenekleri (STT Capabilities)
  # --------------------------------------------------
  stt-whisper-models: 
  stt-whisper-cache:   

services:
  # =============================================================
  # KATMAN 4: YAPAY ZEKA UZMAN MOTORLARI (AI EXPERT ENGINES)
  # Gerçek AI işini yapan, potansiyel olarak yavaş başlayan servisler.
  # =============================================================

  stt-whisper-service:
    restart: unless-stopped
    networks:
      - sentiric-net
    
    # Portlar: HTTP (15030), gRPC (15031), Metrics (15032)
    ports:
      - "15030:15030"
      - "15031:15031"
      - "15032:15032"
    
    # Model Kalıcılığı
    volumes:
      - stt-whisper-models:/models

    environment:
      # --- Network Ayarları ---
      - STT_WHISPER_SERVICE_LISTEN_ADDRESS=0.0.0.0
      - STT_WHISPER_SERVICE_HTTP_PORT=15030
      - STT_WHISPER_SERVICE_GRPC_PORT=15031
      - STT_WHISPER_SERVICE_METRICS_PORT=15032
      
      # --- Model Yönetimi ---
      - STT_WHISPER_SERVICE_MODEL_DIR=/models
      - STT_WHISPER_SERVICE_MODEL_FILENAME=ggml-large-v3-turbo-q8_0.bin
      # VAD Modeli (Otomatik indirilir)
      - STT_WHISPER_SERVICE_VAD_MODEL=ggml-silero-vad.bin
      
      # --- Motor ve Performans ---
      - STT_WHISPER_SERVICE_THREADS=4
      - STT_WHISPER_SERVICE_DEVICE=auto
      # Dynamic Batching (Aynı anda işlenecek istek sayısı)
      - STT_WHISPER_SERVICE_PARALLEL_REQUESTS=2
      # Queue Timeout (Kuyrukta bekleme süresi ms) - CPU için uzun tutuyoruz
      - STT_WHISPER_SERVICE_QUEUE_TIMEOUT_MS=60000
      
      # --- Transkripsiyon Ayarları ---
      - STT_WHISPER_SERVICE_LANGUAGE=auto
      - STT_WHISPER_SERVICE_TRANSLATE=false
      # Konuşmacı Ayrıştırma
      - STT_WHISPER_SERVICE_ENABLE_DIARIZATION=true
      - STT_WHISPER_SERVICE_ENABLE_VAD=true
      
      # --- Gelişmiş Ayarlar (Halüsinasyon Önleme) ---
      - STT_WHISPER_SERVICE_BEAM_SIZE=5
      - STT_WHISPER_SERVICE_TEMPERATURE=0.0
      - STT_WHISPER_SERVICE_BEST_OF=5
      # GÜNCELLENDİ: Düşük güvenli kelimeleri at
      - STT_WHISPER_SERVICE_LOGPROB_THRESHOLD=-0.8
      # GÜNCELLENDİ: Sessizlikte konuşma algılama eşiği (Sıkılaştırıldı)
      - STT_WHISPER_SERVICE_NO_SPEECH_THRESHOLD=0.9
      
      - STT_WHISPER_SERVICE_FLASH_ATTN=true
      - STT_WHISPER_SERVICE_SUPPRESS_NST=false
      
      # --- Loglama ---
      - STT_WHISPER_SERVICE_LOG_LEVEL=info

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:15030/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10m